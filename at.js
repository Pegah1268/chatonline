(function(){(function(a){if(typeof define==="function"&&define.amd){return define(["jquery"],a)}else{return a(window.jQuery)}})(function(e){var g,f,d,c,a,b;b="caret";g=(function(){function h(i){this.$inputor=i;this.domInputor=this.$inputor[0]}h.prototype.setPos=function(i){return this.domInputor};h.prototype.getIEPosition=function(){return e.noop()};h.prototype.getPosition=function(){return e.noop()};h.prototype.getOldIEPos=function(){var j,i;i=document.selection.createRange();j=document.body.createTextRange();j.moveToElementText(this.domInputor);j.setEndPoint("EndToEnd",i);return j.text.length};h.prototype.getPos=function(){var i,k,j;if(j=this.range()){i=j.cloneRange();i.selectNodeContents(this.domInputor);i.setEnd(j.endContainer,j.endOffset);k=i.toString().length;i.detach();return k}else{if(document.selection){return this.getOldIEPos()}}};h.prototype.getOldIEOffset=function(){var i,j;i=document.selection.createRange().duplicate();i.moveStart("character",-1);j=i.getBoundingClientRect();return{height:j.bottom-j.top,left:j.left,top:j.top}};h.prototype.getOffset=function(m){var i,l,j,k;l=null;if(window.getSelection&&(j=this.range())){if(j.endOffset-1<0){return null}i=j.cloneRange();i.setStart(j.endContainer,j.endOffset-1);i.setEnd(j.endContainer,j.endOffset);k=i.getBoundingClientRect();l={height:k.height,left:k.left+k.width,top:k.top};i.detach();l}else{if(document.selection){this.getOldIEOffset()}}return c.adjustOffset(l,this.$inputor)};h.prototype.range=function(){var i;if(!window.getSelection){return}i=window.getSelection();if(i.rangeCount>0){return i.getRangeAt(0)}else{return null}};return h})();f=(function(){function h(i){this.$inputor=i;this.domInputor=this.$inputor[0]}h.prototype.getIEPos=function(){var l,n,j,m,o,k,i;n=this.domInputor;k=document.selection.createRange();o=0;if(k&&k.parentElement()===n){m=n.value.replace(/\r\n/g,"\n");j=m.length;i=n.createTextRange();i.moveToBookmark(k.getBookmark());l=n.createTextRange();l.collapse(false);if(i.compareEndPoints("StartToEnd",l)>-1){o=j}else{o=-i.moveStart("character",-j)}}return o};h.prototype.getPos=function(){if(document.selection){return this.getIEPos()}else{return this.domInputor.selectionStart}};h.prototype.setPos=function(k){var j,i;j=this.domInputor;if(document.selection){i=j.createTextRange();i.move("character",k);i.select()}else{if(j.setSelectionRange){j.setSelectionRange(k,k)}}return j};h.prototype.getIEOffset=function(n){var k,j,l,i,m;l=this.domInputor.createTextRange();if(n){l.move("character",n)}else{j=document.selection.createRange();l.moveToBookmark(j.getBookmark())}i=l.boundingLeft;m=l.boundingTop;k=l.boundingHeight;return{left:i,top:m,height:k}};h.prototype.getOffset=function(l){var j,k,i;j=this.$inputor;if(document.selection){return c.adjustOffset(this.getIEOffset(l),j)}else{k=j.offset();i=this.getPosition(l);return k={left:k.left+i.left,top:k.top+i.top,height:i.height}}};h.prototype.getPosition=function(o){var m,n,l,j,k,i;m=this.$inputor;l=function(p){return p.replace(/</g,"&lt").replace(/>/g,"&gt").replace(/`/g,"&#96").replace(/"/g,"&quot").replace(/\r\n|\r|\n/g,"<br />")};if(o===void 0){o=this.getPos()}i=m.val().slice(0,o);j="<span>"+l(i)+"</span>";j+="<span id='caret'>|</span>";k=new d(m);return n=k.create(j).rect()};h.prototype.getIEPosition=function(n){var j,m,k,i,l;k=this.getIEOffset(n);m=this.$inputor.offset();i=k.left-m.left;l=k.top-m.top;j=k.height;return{left:i,top:l,height:j}};return h})();d=(function(){h.prototype.css_attr=["overflowY","height","width","paddingTop","paddingLeft","paddingRight","paddingBottom","marginTop","marginLeft","marginRight","marginBottom","fontFamily","borderStyle","borderWidth","wordWrap","fontSize","lineHeight","overflowX","text-align"];function h(i){this.$inputor=i}h.prototype.mirrorCss=function(){var i,j=this;i={position:"absolute",left:-9999,top:0,zIndex:-20000,"white-space":"pre-wrap"};e.each(this.css_attr,function(k,l){return i[l]=j.$inputor.css(l)});return i};h.prototype.create=function(i){this.$mirror=e("<div></div>");this.$mirror.css(this.mirrorCss());this.$mirror.html(i);this.$inputor.after(this.$mirror);return this};h.prototype.rect=function(){var j,k,i;j=this.$mirror.find("#caret");k=j.position();i={left:k.left,top:k.top,height:j.height()};this.$mirror.remove();return i};return h})();c={adjustOffset:function(i,h){if(!i){return}i.top+=e(window).scrollTop()+h.scrollTop();i.left+=+e(window).scrollLeft()+h.scrollLeft();return i},contentEditable:function(h){return !!(h[0].contentEditable&&h[0].contentEditable==="true")}};a={pos:function(h){if(h){return this.setPos(h)}else{return this.getPos()}},position:function(h){if(document.selection){return this.getIEPosition(h)}else{return this.getPosition(h)}},offset:function(h){return this.getOffset(h)}};e.fn.caret=function(i){var h;h=c.contentEditable(this)?new g(this):new f(this);if(a[i]){return a[i].apply(h,Array.prototype.slice.call(arguments,1))}else{return e.error("Method "+i+" does not exist on jQuery.caret")}};e.fn.caret.EditableCaret=g;e.fn.caret.InputCaret=f;e.fn.caret.Utils=c;return e.fn.caret.apis=a})}).call(this);(function(){var a=[].slice;(function(b){if(typeof define==="function"&&define.amd){return define(["jquery"],b)}else{return b(window.jQuery)}})(function(g){var d,h,e,j,f,i,k,c,b;e=(function(){function l(m){this.current_flag=null;this.controllers={};this.$inputor=g(m);this.listen()}l.prototype.controller=function(m){return this.controllers[m||this.current_flag]};l.prototype.set_context_for=function(m){this.current_flag=m;return this};l.prototype.reg=function(n,p){var m,o;m=(o=this.controllers)[n]||(o[n]=new f(this,n));if(p.alias){this.controllers[p.alias]=m}m.init(p);return this};l.prototype.listen=function(){var m=this;return this.$inputor.on("keyup.atwho",function(n){return m.on_keyup(n)}).on("keydown.atwho",function(n){return m.on_keydown(n)}).on("scroll.atwho",function(o){var n;return(n=m.controller())!=null?n.view.hide():void 0}).on("blur.atwho",function(n){var o;if(o=m.controller()){return o.view.hide(o.get_opt("display_timeout"))}})};l.prototype.dispatch=function(){var m=this;return g.map(this.controllers,function(n){if(n.look_up()){return m.set_context_for(n.at)}})};l.prototype.on_keyup=function(n){var m;switch(n.keyCode){case k.ESC:n.preventDefault();if((m=this.controller())!=null){m.view.hide()}break;case k.DOWN:case k.UP:g.noop();break;default:this.dispatch()}};l.prototype.on_keydown=function(o){var m,n;m=(n=this.controller())!=null?n.view:void 0;if(!(m&&m.visible())){return}switch(o.keyCode){case k.ESC:o.preventDefault();m.hide();break;case k.UP:o.preventDefault();m.prev();break;case k.DOWN:o.preventDefault();m.next();break;case k.TAB:case k.ENTER:if(!m.visible()){return}o.preventDefault();m.choose();break;default:g.noop()}};return l})();f=(function(){var m,l;l=0;m=function(){return l+=1};function n(p,o){this.app=p;this.at=o;this.$inputor=this.app.$inputor;this.id=this.$inputor[0].id||m();this.setting=null;this.query=null;this.pos=0;this.cur_rect=null;this.range=null;d.append(this.$el=g("<div id='atwho-ground-"+this.id+"'></div>"));this.model=new c(this);this.view=new b(this)}n.prototype.init=function(o){this.setting=g.extend({},this.setting||g.fn.atwho["default"],o);this.view.init();return this.model.reload(this.setting.data)};n.prototype.call_default=function(){var q,o;o=arguments[0],q=2<=arguments.length?a.call(arguments,1):[];try{return i[o].apply(this,q)}catch(p){return g.error(""+p+" Or maybe At.js doesn't have function "+o)}};n.prototype.trigger=function(o,q){var p,r;q.push(this);p=this.get_opt("alias");r=p?""+o+"-"+p+".atwho":""+o+".atwho";return this.$inputor.trigger(r,q)};n.prototype.callbacks=function(o){return this.get_opt("callbacks")[o]||i[o]};n.prototype.get_opt=function(p,o){try{return this.setting[p]}catch(q){return null}};n.prototype.content=function(){if(this.$inputor.is("textarea, input")){return this.$inputor.val()}else{return this.$inputor.text()}};n.prototype.catch_query=function(){var o,r,p,s,t,q;r=this.content();o=this.$inputor.caret("pos");q=r.slice(0,o);s=this.callbacks("matcher").call(this,this.at,q,this.get_opt("start_with_space"));if(typeof s==="string"&&s.length<=this.get_opt("max_len",20)){t=o-s.length;p=t+s.length;this.pos=t;s={text:s.toLowerCase(),head_pos:t,end_pos:p};this.trigger("matched",[this.at,s.text])}else{this.view.hide()}return this.query=s};n.prototype.rect=function(){var p,o;if(!(p=this.$inputor.caret("offset",this.pos-1))){return}if(this.$inputor.attr("contentEditable")==="true"){p=(this.cur_rect||(this.cur_rect=p))||p}o=document.selection?0:2;return{left:p.left,top:p.top,bottom:p.top+p.height+o}};n.prototype.reset_rect=function(){if(this.$inputor.attr("contentEditable")==="true"){return this.cur_rect=null}};n.prototype.mark_range=function(){return this.range=this.get_range()||this.get_ie_range()};n.prototype.clear_range=function(){return this.range=null};n.prototype.get_range=function(){return this.range||(window.getSelection?window.getSelection().getRangeAt(0):void 0)};n.prototype.get_ie_range=function(){return this.range||(document.selection?document.selection.createRange():void 0)};n.prototype.insert_content_for=function(r){var q,p,o;p=r.data("value");o=this.get_opt("insert_tpl");if(this.$inputor.is("textarea, input")||!o){return p}q=g.extend({},r.data("item-data"),{"atwho-data-value":p,"atwho-at":this.at});return this.callbacks("tpl_eval").call(this,o,q)};n.prototype.insert=function(u,w){var y,z,r,p,v,x,t,q,o,s,A;y=this.$inputor;if(y.attr("contentEditable")==="true"){r="atwho-view-flag atwho-view-flag-"+(this.get_opt("alias")||this.at);p=""+u+"<span contenteditable='false'>&nbsp;<span>";v="<span contenteditable='false' class='"+r+"'>"+p+"</span>";z=g(v).data("atwho-data-item",w.data("item-data"));if(document.selection){z=g("<span contenteditable='true'></span>").html(z)}}if(y.is("textarea, input")){u=""+u;o=y.val();s=o.slice(0,Math.max(this.query.head_pos-this.at.length,0));A=""+s+u+" "+(o.slice(this.query.end_pos||0));y.val(A);y.caret("pos",s.length+u.length+1)}else{if(t=this.get_range()){x=t.startOffset-(this.query.end_pos-this.query.head_pos)-this.at.length;t.setStart(t.endContainer,Math.max(x,0));t.setEnd(t.endContainer,t.endOffset);t.deleteContents();t.insertNode(z[0]);t.collapse(false);q=window.getSelection();q.removeAllRanges();q.addRange(t)}else{if(t=this.get_ie_range()){t.moveStart("character",this.query.end_pos-this.query.head_pos-this.at.length);t.pasteHTML(z[0]);t.collapse(false);t.select()}}}y.focus();return y.change()};n.prototype.render_view=function(p){var o;o=this.get_opt("search_key");p=this.callbacks("sorter").call(this,this.query.text,p.slice(0,1001),o);return this.view.render(p.slice(0,this.get_opt("limit")))};n.prototype.look_up=function(){var p,o;if(!(p=this.catch_query())){return}o=function(q){if(q&&q.length>0){return this.render_view(q)}else{return this.view.hide()}};this.model.query(p.text,g.proxy(o,this));return p};return n})();c=(function(){var l;l={};function m(n){this.context=n;this.at=this.context.at}m.prototype.saved=function(){return this.fetch()>0};m.prototype.query=function(q,r){var p,n,o;p=this.fetch();n=this.context.get_opt("search_key");r(p=this.context.callbacks("filter").call(this.context,q,p,n));if(!(p&&p.length>0)){return(o=this.context.callbacks("remote_filter"))!=null?o.call(this.context,q,r):void 0}};m.prototype.fetch=function(){return l[this.at]||[]};m.prototype.save=function(n){return l[this.at]=this.context.callbacks("before_save").call(this.context,n||[])};m.prototype.load=function(n){if(!(this.saved()||!n)){return this._load(n)}};m.prototype.reload=function(n){return this._load(n)};m.prototype._load=function(n){var o=this;if(typeof n==="string"){return g.ajax(n,{dataType:"json"}).done(function(p){return o.save(p)})}else{return this.save(n)}};return m})();b=(function(){function l(m){this.context=m;this.$el=g("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>");this.timeout_id=null;this.context.$el.append(this.$el);this.bind_event()}l.prototype.init=function(){var m;m=this.context.get_opt("alias")||this.context.at.charCodeAt(0);return this.$el.attr({id:"at-view-"+m})};l.prototype.bind_event=function(){var m,n=this;m=this.$el.find("ul");m.on("mouseenter.atwho-view","li",function(o){m.find(".cur").removeClass("cur");return g(o.currentTarget).addClass("cur")}).on("click",function(o){n.choose();return o.preventDefault()});return this.$el.on("mouseenter.atwho-view","ul",function(o){return n.context.mark_range()}).on("mouseleave.atwho-view","ul",function(o){return n.context.clear_range()})};l.prototype.visible=function(){return this.$el.is(":visible")};l.prototype.choose=function(){var n,m;n=this.$el.find(".cur");m=this.context.insert_content_for(n);this.context.insert(this.context.callbacks("before_insert").call(this.context,m,n),n);this.context.trigger("inserted",[n]);return this.hide()};l.prototype.reposition=function(m){var n;if(m.bottom+this.$el.height()-g(window).scrollTop()>g(window).height()){m.bottom=m.top-this.$el.height()}n={left:m.left,top:m.bottom};this.$el.offset(n);return this.context.trigger("reposition",[n])};l.prototype.next=function(){var n,m;n=this.$el.find(".cur").removeClass("cur");m=n.next();if(!m.length){m=this.$el.find("li:first")}return m.addClass("cur")};l.prototype.prev=function(){var n,m;n=this.$el.find(".cur").removeClass("cur");m=n.prev();if(!m.length){m=this.$el.find("li:last")}return m.addClass("cur")};l.prototype.show=function(){var m;if(!this.visible()){this.$el.show()}if(m=this.context.rect()){return this.reposition(m)}};l.prototype.hide=function(m){var o,n=this;if(isNaN(m&&this.visible())){this.context.reset_rect();return this.$el.hide()}else{o=function(){return n.hide()};clearTimeout(this.timeout_id);return this.timeout_id=setTimeout(o,m)}};l.prototype.render=function(s){var t,p,q,m,o,r,n;if(!g.isArray(s||s.length<=0)){this.hide();return}this.$el.find("ul").empty();p=this.$el.find("ul");o=this.context.get_opt("tpl");for(r=0,n=s.length;r<n;r++){q=s[r];q=g.extend({},q,{"atwho-at":this.context.at});m=this.context.callbacks("tpl_eval").call(this.context,o,q);t=g(this.context.callbacks("highlighter").call(this.context,m,this.context.query.text));t.data("item-data",q);p.append(t)}this.show();return p.find("li:first").addClass("cur")};return l})();k={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13};i={before_save:function(p){var n,o,m,l;if(!g.isArray(p)){return p}l=[];for(o=0,m=p.length;o<m;o++){n=p[o];if(g.isPlainObject(n)){l.push(n)}else{l.push({name:n})}}return l},matcher:function(m,o,l){var n,p;m=m.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");if(l){m="(?:^|\\s)"+m}p=new RegExp(m+"([A-Za-z0-9_+-]*)$|"+m+"([^\\x00-\\xff]*)$","gi");n=p.exec(o);if(n){return n[2]||n[1]}else{return null}},filter:function(r,q,o){var n,p,m,l;l=[];for(p=0,m=q.length;p<m;p++){n=q[p];if(~n[o].toLowerCase().indexOf(r)){l.push(n)}}return l},remote_filter:null,sorter:function(r,n,p){var o,q,m,l;if(!r){return n}l=[];for(q=0,m=n.length;q<m;q++){o=n[q];o.atwho_order=o[p].toLowerCase().indexOf(r);if(o.atwho_order>-1){l.push(o)}}return l.sort(function(t,s){return t.atwho_order-s.atwho_order})},tpl_eval:function(m,n){try{return m.replace(/\$\{([^\}]*)\}/g,function(o,p,q){return n[p]})}catch(l){return""}},highlighter:function(l,n){var m;if(!n){return l}m=new RegExp(">\\s*(\\w*)("+n.replace("+","\\+")+")(\\w*)\\s*<","ig");return l.replace(m,function(q,o,r,p){return"> "+o+"<strong>"+r+"</strong>"+p+" <"})},before_insert:function(l,m){return l}};h={load:function(l,m){var n;if(n=this.controller(l)){return n.model.load(m)}},getInsertedItemsWithIDs:function(l){var o,n,m;if(!(o=this.controller(l))){return[null,null]}if(l){l="-"+(o.get_opt("alias")||o.at)}n=[];m=g.map(this.$inputor.find("span.atwho-view-flag"+(l||"")),function(p){var q;q=g(p).data("atwho-data-item");if(n.indexOf(q.id)>-1){return}if(q.id){n.push=q.id}return q});return[n,m]},getInsertedItems:function(l){return h.getInsertedItemsWithIDs.apply(this,[l])[1]},getInsertedIDs:function(l){return h.getInsertedItemsWithIDs.apply(this,[l])[0]},run:function(){return this.dispatch()}};j={init:function(l){var m,n;n=(m=g(this)).data("atwho");if(!n){m.data("atwho",(n=new e(this)))}n.reg(l.at,l);return this}};d=g("<div id='atwho-container'></div>");g.fn.atwho=function(n){var l,m;m=arguments;g("body").append(d);l=null;this.filter("textarea, input, [contenteditable=true]").each(function(){var o;if(typeof n==="object"||!n){return j.init.apply(this,m)}else{if(h[n]){if(o=g(this).data("atwho")){return l=h[n].apply(o,Array.prototype.slice.call(m,1))}}else{return g.error("Method "+n+" does not exist on jQuery.caret")}}});return l||this};return g.fn.atwho["default"]={at:void 0,alias:void 0,data:null,tpl:"<li data-value='${atwho-at}${name}'>${name}</li>",insert_tpl:"<span>${atwho-data-value}</span>",callbacks:i,search_key:"name",start_with_space:true,limit:5,max_len:20,display_timeout:300}})}).call(this);